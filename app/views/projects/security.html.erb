<% @meta_title = "#{@project} security" %>
<% @meta_description = "Security advisories and Dependabot security updates for #{@project}" %>

<%= render 'project_header' %>
<div class="container">

  <div class="dashboard-layout">
    <%= render 'nav' %>

    <div class="dashboard-layout__dboard">
      <div class="d-md-flex justify-content-between align-items-center mb-4">
        <h1>Security</h1>
      </div>

      <%= render 'date_nav' %>

      <!-- Security Overview Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Security Advisories</h5>
              <h2 class="text-warning"><%= @pagy.count %></h2>
              <small class="text-muted">in <%= @range == 'year' ? @year : "#{Date::MONTHNAMES[@month]} #{@year}" %></small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Dependabot Security PRs</h5>
              <h2 class="text-info"><%= @dependabot_filtered_count %></h2>
              <small class="text-muted">
                <span class="text-success"><%= @dependabot_closed_security %> resolved</span> • 
                <span class="text-danger"><%= @dependabot_open_security %> open</span>
              </small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Total Security Issues</h5>
              <h2 class="text-primary"><%= @pagy.count + @dependabot_filtered_count %></h2>
              <small class="text-muted">advisories + dependabot PRs</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Response Rate</h5>
              <h2 class="text-success">
                <%= @dependabot_security_count > 0 ? number_to_percentage((@dependabot_closed_security.to_f / @dependabot_security_count * 100), precision: 0) : "N/A" %>
              </h2>
              <small class="text-muted">Dependabot PRs resolved</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Security Activity Chart -->
      <% if @dependabot_security_per_period.values.sum > 0 || @advisories_per_period.values.sum > 0 %>
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Security Activity Over Time</h5>
            <canvas id="securityChart" width="400" height="200"></canvas>
          </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
          const ctx = document.getElementById('securityChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: <%= @dependabot_security_per_period.keys.to_json.html_safe %>,
              datasets: [{
                label: 'Security Advisories',
                data: <%= @advisories_per_period.values.to_json.html_safe %>,
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                borderWidth: 2,
                fill: true
              }, {
                label: 'Dependabot Security PRs',
                data: <%= @dependabot_security_per_period.values.to_json.html_safe %>,
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                borderWidth: 2,
                fill: true
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1
                  }
                }
              },
              plugins: {
                legend: {
                  position: 'top'
                }
              }
            }
          });
        });
        </script>
      <% end %>

      <!-- Recent Dependabot Security PRs -->
      <% if @recent_dependabot_security.any? %>
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Recent Dependabot Security PRs</h5>
          </div>
          <div class="card-body">
            <% @recent_dependabot_security.each do |issue| %>
              <div class="d-flex justify-content-between align-items-start mb-3 pb-3 border-bottom">
                <div class="flex-grow-1">
                  <h6 class="mb-1">
                    <% if issue.html_url.present? %>
                      <%= link_to issue.title, issue.html_url, target: '_blank', class: 'text-decoration-none' %>
                    <% else %>
                      <%= issue.title %>
                    <% end %>
                  </h6>
                  <div class="d-flex align-items-center gap-2 text-muted small">
                    <span class="badge bg-<%= issue.effective_state == 'merged' ? 'success' : issue.effective_state == 'open' ? 'primary' : 'secondary' %>">
                      <%= issue.effective_state.upcase %>
                    </span>
                    <span>by <%= issue.user %></span>
                    <span>•</span>
                    <span><%= time_ago_in_words(issue.created_at) %> ago</span>
                    <% if issue.package_names.any? %>
                      <span>•</span>
                      <span>Packages: <%= issue.package_names.join(', ') %></span>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
            <div class="text-center mt-3">
              <%= link_to "View all Dependabot security issues →", issues_project_path(@project, user: 'dependabot'), class: 'btn btn-outline-primary btn-sm' %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Security Documentation -->
      <% if @project.repository.present? %>
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Security Documentation</h5>
          </div>
          <div class="card-body">
            <% if @project.has_repository_metadata_files? %>
              <% if @project.has_security_documentation? %>
                <p class="text-muted mb-3">This repository includes the following security documentation:</p>
                <ul class="list-unstyled">
                  <% @project.security_documentation_files.each do |k, v| %>
                    <li class="mb-2">
                      <i class="fa fa-file-text text-info me-2"></i>
                      <strong><%= k.humanize %>:</strong> 
                      <%= link_to v, @project.blob_url(v), target: '_blank', class: 'text-decoration-none' %>
                    </li>
                  <% end %>
                </ul>
              <% else %>
                <p class="text-muted mb-0">
                  <i class="fa fa-info-circle text-warning me-2"></i>
                  No security documentation files (such as SECURITY.md or threat model files) were found in this repository.
                </p>
              <% end %>
            <% else %>
              <p class="text-muted mb-0">
                <i class="fa fa-info-circle text-warning me-2"></i>
                No repository metadata available to check for security documentation files.
              </p>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Security Advisories -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Security Advisories</h5>
        </div>
        <div class="card-body">
          <% if @pagy.count > 0 %>
            <%= render @advisories %>
            <%== pagy_bootstrap_nav(@pagy) if @pagy.pages > 1 %>  
          <% else %>
            <p class="text-muted">
              No security advisories found in <%= @range == 'year' ? @year : "#{Date::MONTHNAMES[@month]} #{@year}" %>.
            </p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>