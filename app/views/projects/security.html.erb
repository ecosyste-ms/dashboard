<% @meta_title = "#{@project} security" %>
<% @meta_description = "Security advisories and Dependabot security updates for #{@project}" %>

<%= render 'project_header' %>
<div class="container">

  <div class="dashboard-layout">
    <%= render 'nav' %>

    <div class="dashboard-layout__dboard">
      <div class="d-md-flex justify-content-between align-items-center mb-4">
        <h1>Security</h1>
      </div>

      <%= render 'date_nav' %>

      <!-- Security Overview Cards -->
      <div class="dashboard-grid">
        <div class="four-equal-widgets mb-4">
          <div class="card well p-3 border-0">
            <div class="card-body">
              <h5 class="card-title small">Security Advisories</h5>
              <div class="stat-card mb-2">
                <div class="stat-card-body">
                  <span class="stat-card-title stat-card-number stat-card-number-neutral"><%= @pagy.count %></span>
                  <span class="stat-card-text stat-card-text--small">in <%= @range == 'year' ? @year : "#{Date::MONTHNAMES[@month]} #{@year}" %></span>
                </div>
              </div>
            </div>
          </div>

          <div class="card well p-3 border-0">
            <div class="card-body">
              <h5 class="card-title small">Dependabot Security PRs</h5>
              <div class="stat-card mb-2">
                <div class="stat-card-body">
                  <span class="stat-card-title stat-card-number stat-card-number-neutral"><%= @dependabot_filtered_count %></span>
                  <span class="stat-card-text stat-card-text--small"><%= @dependabot_closed_security %> resolved, <%= @dependabot_open_security %> open</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card well p-3 border-0">
            <div class="card-body">
              <h5 class="card-title small">Total Security Issues</h5>
              <div class="stat-card mb-2">
                <div class="stat-card-body">
                  <span class="stat-card-title stat-card-number stat-card-number-neutral"><%= @pagy.count + @dependabot_filtered_count %></span>
                  <span class="stat-card-text stat-card-text--small">Advisories + dependabot PRs</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card well p-3 border-0">
            <div class="card-body">
              <h5 class="card-title small">Response Rate</h5>
              <div class="stat-card mb-2">
                <div class="stat-card-body">
                  <span class="stat-card-title stat-card-number stat-card-number-neutral">
                  <%= @dependabot_security_count > 0 ? number_to_percentage((@dependabot_closed_security.to_f / @dependabot_security_count * 100), precision: 0) : "N/A" %></span>
                  <span class="stat-card-text stat-card-text--small">Dependabot PRs resolved</span>
                </div>
              </div>
            </div>
          </div>
        
        </div>
      </div>

      <!-- Security Activity Chart -->
      
      <% if @dependabot_security_per_period.values.sum > 0 || @advisories_per_period.values.sum > 0 %>
      <div class="full-width-widget">
        <div class="card well p-3 border-0 mb-4">
          <div class="card-body">
            <h5 class="card-title">Security Activity Over Time</h5>
            <canvas id="securityChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
          const ctx = document.getElementById('securityChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: <%= @dependabot_security_per_period.keys.to_json.html_safe %>,
              datasets: [{
                label: 'Security Advisories',
                data: <%= @advisories_per_period.values.to_json.html_safe %>,
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                borderWidth: 2,
                fill: true
              }, {
                label: 'Dependabot Security PRs',
                data: <%= @dependabot_security_per_period.values.to_json.html_safe %>,
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                borderWidth: 2,
                fill: true
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1
                  }
                }
              },
              plugins: {
                legend: {
                  position: 'top'
                }
              }
            }
          });
        });
        </script>
      <% end %>

      <!-- Recent Dependabot Security PRs -->
      <% if @recent_dependabot_security.any? %>
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Recent Dependabot Security PRs</h5>
          </div>
          <div class="card-body">
            <% @recent_dependabot_security.each do |issue| %>
              <div class="card mb-4 pb-4 listing">
                <div class="card-body p-0">
                  <% if issue.effective_state.present? %>
                    <span class="listing__badge badge bg-<%= issue.effective_state == 'merged' ? 'success' : issue.effective_state == 'open' ? 'primary' : 'secondary' %>">
                      <%= issue.effective_state.humanize %>
                    </span>
                  <% end %>

                  <div class="text-muted float-end listing__time">
                    <% if issue.effective_state == 'merged' && issue.respond_to?(:merged_at) && issue.merged_at.present? %>
                      <span title="<%= issue.merged_at %>">Merged <%= time_ago_in_words(issue.merged_at) %> ago</span>
                    <% else %>
                      <span title="<%= issue.created_at %>"><%= time_ago_in_words(issue.created_at) %> ago</span>
                    <% end %>
                  </div>

                  <h3 class="card-title listing__title mt-3">
                    <% if issue.html_url.present? %>
                      <a href="<%= issue.html_url %>" target="_blank" rel="noopener">
                        <%= issue.title %>
                        <% if issue.respond_to?(:number) && issue.number.present? %>
                          <span class="listing__meta">#<%= issue.number %></span>
                        <% end %>
                      </a>
                    <% else %>
                      <%= issue.title %>
                      <% if issue.respond_to?(:number) && issue.number.present? %>
                        <span class="listing__meta">#<%= issue.number %></span>
                      <% end %>
                    <% end %>
                  </h3>

                  <div class="mt-3 listing__details">
                    <div class="d-flex align-items-top">
                      <%= bootstrap_icon 'robot', width: 18, height: 18, class: 'flex-shrink-0 me-2' %>
                      <span class="me-3"><%= issue.user %></span>

                      <% if issue.package_names.any? %>
                        <%= bootstrap_icon 'boxes', width: 18, height: 18, class: 'flex-shrink-0 me-2', alt: 'packages' %>
                        <span><%= issue.package_names.join(', ') %></span>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
            <div class="mt-3">
              <%= link_to "View all Dependabot security issues â†’", issues_project_path(@project, user: 'dependabot'), class: 'small spesh-link' %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Security Documentation -->
      <% if @project.repository.present? %>
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Security Documentation</h5>
          </div>
          <div class="card-body">
            <% if @project.has_repository_metadata_files? %>
              <% if @project.has_security_documentation? %>
                <p class="text-muted mb-3">This repository includes the following security documentation:</p>
                <ul class="list-unstyled">
                  <% @project.security_documentation_files.each do |k, v| %>
                    <li class="mb-2">
                      <i class="fa fa-file-text text-info me-2"></i>
                      <strong><%= k.humanize %>:</strong> 
                      <%= link_to v, @project.blob_url(v), target: '_blank', class: 'text-decoration-none' %>
                    </li>
                  <% end %>
                </ul>
              <% else %>
                <p class="text-muted mb-0">
                  <i class="fa fa-info-circle text-warning me-2"></i>
                  No security documentation files (such as SECURITY.md or threat model files) were found in this repository.
                </p>
              <% end %>
            <% else %>
              <p class="text-muted mb-0">
                <i class="fa fa-info-circle text-warning me-2"></i>
                No repository metadata available to check for security documentation files.
              </p>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Security Advisories -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Security Advisories</h5>
        </div>
        <div class="card-body">
          <% if @pagy.count > 0 %>
            <%= render @advisories %>
            <%== pagy_bootstrap_nav(@pagy) if @pagy.pages > 1 %>  
          <% else %>
            <p class="text-muted">
              No security advisories found in <%= @range == 'year' ? @year : "#{Date::MONTHNAMES[@month]} #{@year}" %>.
            </p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>