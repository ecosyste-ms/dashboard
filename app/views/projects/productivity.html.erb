<% @meta_title = "#{@project} - Productivity" %>
<% @meta_description = "Development productivity metrics for #{@project} including commit frequency, release activity, and code changes" %>

<%= render 'project_header' %>
<div class="container">

  <div class="dashboard-layout">
    <%= render 'nav' %>

    <div class="dashboard-layout__dboard">
      <div class="dboard__title-bar d-flex justify-content-between align-items-center mb-4">
        <h1>Productivity</h1>
        <%= render 'bots' %>
      </div>
      <%= render 'date_nav' %>

      <div class="dashboard-grid">
        <div class="full-width-widget">
          <div class="card well p-3 border-0">
            <div class="card-body">
              <h5 class="card-title">Activity Trends</h5>
              <div class="chart-wrapper">
                <canvas 
                  id="productivityChart" 
                  width="600"
                  data-chart="line"
                  data-chart-data='<%= {
                    labels: @new_issues_per_period.map(&:first),
                    datasets: [
                      {
                        label: "New Issues",
                        data: @new_issues_per_period.map(&:last),
                        borderColor: "rgb(255, 99, 132)",
                        backgroundColor: "rgba(255, 99, 132, 0.1)",
                        borderWidth: 3,
                        pointRadius: 3,
                        tension: 0.4,
                        fill: true
                      },
                      {
                        label: "New PRs",
                        data: @new_prs_per_period.map(&:last),
                        borderColor: "rgb(54, 162, 235)",
                        backgroundColor: "rgba(54, 162, 235, 0.1)",
                        borderWidth: 3,
                        pointRadius: 3,
                        tension: 0.4,
                        fill: true
                      }
                    ]
                  }.to_json.html_safe %>'
                  data-chart-options='<%= {
                    scales: {
                      y: {
                        beginAtZero: true,
                        max: ([@new_issues_per_period.map(&:last).max.to_i, @new_prs_per_period.map(&:last).max.to_i].max * 1.1).ceil
                      }
                    }
                  }.to_json.html_safe %>'
                ></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <div class="two-thirds-widgets">
          <%= stat_card_widget 'Commits', @commits_this_period, @commits_last_period,  increase_good: true, title_class: "card-title small", stat_size: "large", card_class: "two-thirds-widgets__large" %> 
          <%= stat_card_widget 'Commits per author', @avg_commits_per_author_this_period, @avg_commits_per_author_last_period,  increase_good: true, title_class: "card-title small", stat_size: "large", card_class: "two-thirds-widgets__small" %>
        </div>
        <div class="two-thirds-widgets">
          <%= stat_card_widget 'Releases', @tags_this_period, @tags_last_period, increase_good: true, title_class: "card-title small", stat_size: "large", card_class: "two-thirds-widgets__small" %> 
          <%= stat_card_widget 'Vulnerabilities', @advisories_this_period, @advisories_last_period, increase_good: false, title_class: "card-title small", stat_size: "large", card_class: "two-thirds-widgets__large" %> 
        </div>
        <div class="two-thirds-widgets">
          <%= stat_card_widget 'New issues', @new_issues_this_period, @new_issues_last_period, increase_good: false, title_class: "card-title small", stat_size: "large", card_class: "two-thirds-widgets__large" %>
          <%= stat_card_widget 'Open issues', @open_isues_this_period, @open_isues_last_period, increase_good: false, title_class: "card-title small", stat_size: "large", card_class: "two-thirds-widgets__small" %> 
        </div>
        <div class="three-equal-widgets">
          <%= small_widget 'New PRs', @new_prs_last_period, @new_prs_this_period, symbol: '' %>
          <%= small_widget 'Open PRs', @open_prs_this_period, @open_prs_last_period,  symbol: '', increase_good: false %>
          <%= small_widget 'Merged PRs', @merged_prs_this_period, @merged_prs_last_period, symbol: '' %>
        </div>
        
      </div>
    </div>
  </div>
</div>
<%= render 'project_footer' %>