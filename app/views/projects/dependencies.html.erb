<% @meta_title = "#{@project} - Dependencies" %>
<% @meta_description = "Dependency analysis for #{@project} including direct, development, and transitive dependencies with security insights" %>
<%= render 'project_header' %>

<div class="container">

  <div class="dashboard-layout">
    <%= render 'nav' %>

    <div class="dashboard-layout__dboard">
      <div class="d-md-flex justify-content-between align-items-center mb-4">
        <h1>Dependencies</h1>
        <div class="d-flex align-items-center gap-3">
          <% if logged_in? && @project.dependencies.present? %>
            <% existing_collection = @project.dependency_collection_for_user(current_user) %>
            <% if existing_collection %>
              <%= link_to existing_collection, class: "btn btn-success btn-sm" do %>
                <svg width="16" height="16" fill="currentColor" class="bi bi-collection me-1" viewBox="0 0 16 16">
                  <path d="M2.5 3.5a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1zm2-2a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1zM0 13a1.5 1.5 0 0 0 1.5 1.5h13A1.5 1.5 0 0 0 16 11.5v-6A1.5 1.5 0 0 0 14.5 4h-13A1.5 1.5 0 0 0 0 5.5zm1.5 0a.5.5 0 0 1-.5-.5v-6a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-.5.5z"/>
                </svg>
                View Collection
              <% end %>
            <% else %>
              <%= button_to create_collection_from_dependencies_project_path(@project), 
                            method: :post, 
                            class: "btn btn-primary btn-sm",
                            data: { confirm: "This will create a public collection from all dependencies of this project. Continue?" } do %>
                <svg width="16" height="16" fill="currentColor" class="bi bi-collection me-1" viewBox="0 0 16 16">
                  <path d="M2.5 3.5a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1zm2-2a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1zM0 13a1.5 1.5 0 0 0 1.5 1.5h13A1.5 1.5 0 0 0 16 11.5v-6A1.5 1.5 0 0 0 14.5 4h-13A1.5 1.5 0 0 0 0 5.5zm1.5 0a.5.5 0 0 1-.5-.5v-6a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-.5.5z"/>
                </svg>
                Create Collection
              <% end %>
            <% end %>
          <% end %>
          <%= render 'bots' %>
        </div>
      </div>
        <div class="dashboard-grid">
          <div class="three-equal-widgets">
            <%= link_to (params[:filter] == 'direct' ? dependencies_project_path(@project) : dependencies_project_path(@project, filter: 'direct')), class: "card well p-3 border-0 text-decoration-none #{'filter-active' if params[:filter] == 'direct'}" do %>
              <div class="card-body">
                <h5 class="card-title small">Unique direct dependencies</h5>
                <div class="stat-card mb-2">
                  <div class="stat-card-body">
                    <span class="stat-card-title stat-card-title--large stat-card-number-neutral"><%= @direct_dependencies %></span>
                  </div>
                </div>
              </div>
            <% end %>
            <%= link_to (params[:filter] == 'development' ? dependencies_project_path(@project) : dependencies_project_path(@project, filter: 'development')), class: "card well p-3 border-0 text-decoration-none #{'filter-active' if params[:filter] == 'development'}" do %>
              <div class="card-body">
                <h5 class="card-title small">Unique development dependencies</h5>
                <div class="stat-card mb-2">
                  <div class="stat-card-body">
                    <span class="stat-card-title stat-card-title--large stat-card-number-neutral"><%= @development_dependencies %></span>
                  </div>
                </div>
              </div>
            <% end %>
            <%= link_to (params[:filter] == 'transitive' ? dependencies_project_path(@project) : dependencies_project_path(@project, filter: 'transitive')), class: "card well p-3 border-0 text-decoration-none #{'filter-active' if params[:filter] == 'transitive'}" do %>
              <div class="card-body">
                <h5 class="card-title small">Unique transitive dependencies</h5>
                <div class="stat-card mb-2">
                  <div class="stat-card-body">
                    <span class="stat-card-title stat-card-title--large stat-card-number-neutral"><%= @transitive_dependencies %></span>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
          
          <div class="full-width-widget">
            <div class="card well p-3 border-0">
              <div class="card-body">
                <h5 class="card-title">Dependencies</h5>
                <div class="table-responsive">
                  <table class="table table-hover table--purple">
                    <thead>
                      <tr>
                        <th style="width: 30%;">Package Name</th>
                        <th style="width: 12%;">Direct/Trans</th>
                        <th style="width: 18%;">Requirements</th>
                        <th style="width: 12%;">Kind</th>
                        <th style="width: 15%;">Ecosystem</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @unique_dependencies.each do |dep| %>
                        <% package_name = dep['package_name'] || dep['name'] %>
                        <% is_direct = @project.direct_dependencies.any? { |d| (d['package_name'] || d['name']) == package_name } %>
                        <% dep_directness = is_direct ? 'direct' : 'transitive' %>
                        <tr>
                          <td>
                            <% ecosystem = dep['ecosystem'] %>
                            <% if package_name.present? && ecosystem.present? %>
                              <% purl_type = convert_purl_type(ecosystem.downcase) %>
                              <% purl = "pkg:#{purl_type}/#{package_name}" %>
                              <%= link_to package_name, lookup_projects_path(purl: purl), 
                                         class: "text-decoration-none",
                                         title: "Look up #{package_name} project" %>
                            <% else %>
                              <%= package_name || 'N/A' %>
                            <% end %>
                          </td>
                          <td>
                            <% if dep_directness == 'direct' %>
                              <span class="badge bg-primary">Direct</span>
                            <% else %>
                              <span class="badge bg-secondary">Transitive</span>
                            <% end %>
                          </td>
                          <td style="word-break: break-word; max-width: 150px;">
                            <% requirements = dep['requirements'] || 'N/A' %>
                            <% if requirements.length > 15 %>
                              <span title="<%= requirements %>"><%= truncate(requirements, length: 15) %></span>
                            <% else %>
                              <%= requirements %>
                            <% end %>
                          </td>
                          <td><%= dep['kind'] || 'N/A' %></td>
                          <td><%= dep['ecosystem'] || 'N/A' %></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
    </div>
  </div>
</div>
<%= render 'project_footer' %>